<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tesla STEM MUN</title>
  <style>
    :root{
      --bg:#121212; --panel:#1b1b1b; --text:#e8e8e8; --muted:#b9b9b9;
      --brand:#7ec8ff; --danger:#ff6b6b; --border:#2a2a2a;
      --maxw:1100px; --radius:16px; --gap:16px;
    }
    *,*::before,*::after{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      line-height:1.35;
    }
    a{ color:var(--brand); text-decoration:none }
    a:hover{ text-decoration:underline }

    header{
      border-bottom:1px solid var(--border);
      background:#0f0f0f;
      position:sticky; top:0; z-index:5;
    }
    .wrap{ max-width:var(--maxw); margin:0 auto; padding:14px 18px }
    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between }
    .brand{ font-weight:700; font-size:1.05rem }

    nav{ display:flex; gap:10px; flex-wrap:wrap }
    nav a{
      padding:8px 12px;
      border-radius:10px;
      background:var(--panel);
      border:1px solid var(--border);
      transition:box-shadow .2s ease;
    }
    /* inset ring so it never gets clipped */
    nav a[aria-current="page"]{ box-shadow: inset 0 0 0 2px var(--brand); }

    .hero{
      margin:24px auto 12px;
      max-width:var(--maxw);
      padding:18px;
      border:1px solid var(--border);
      background:linear-gradient(180deg,#191919,#131313);
      border-radius:var(--radius);
    }

    .grid{
      max-width:var(--maxw);
      margin:0 auto;
      display:grid;
      gap:var(--gap);
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    }

    .card{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px }
    .muted{ color:var(--muted) }

    .banner{
      max-width:var(--maxw);
      margin:8px auto;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#231919; color:#ffd6d6;
    }
    .error{
      max-width:var(--maxw);
      margin:16px auto;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #5b1f1f;
      background:#2a1414; color:#ffd6d6;
      white-space:pre-wrap;
    }

    .table{ width:100%; border-collapse:collapse }
    .table th,.table td{ border-bottom:1px solid var(--border); padding:10px 8px; text-align:left }

    .pill{
      display:inline-block; padding:2px 8px;
      border:1px solid var(--border); border-radius:999px;
      color:var(--muted); font-size:.8rem; margin-right:6px;
    }
    .ok{ background:#143a14; color:#c2ffd0; border-color:#1f4f20 }

    /* ===== Topic detail 3-column layout ===== */
    .grid-topic{
      display:grid; gap:var(--gap);
      grid-template-columns: 1.2fr 1fr 1.2fr;
      grid-template-areas: "about middle matrix";
      align-items:start;
      max-width:var(--maxw); margin:0 auto;
    }
    .col-about{ grid-area:about }
    .col-middle{ grid-area:middle; display:grid; gap:var(--gap) }
    .col-matrix{ grid-area:matrix }

    /* ===== Mobile gutters + phone tweaks ===== */
    @media (max-width: 720px){
      /* universal side gutter for routed content */
      main{ padding-inline:12px; }
      /* keep full-width blocks aligned with content */
      .hero, .banner, .error{ margin-left:12px; margin-right:12px; }

      .topbar{ gap:8px }
      .brand{ font-size:1rem }

      /* horizontal scrollable nav with inner padding so rings don't clip */
      nav{
        overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch;
        gap:8px; padding:6px 10px;            /* inner gutter */
        scroll-padding-inline:12px;           /* keeps first/last in view */
      }
      nav::-webkit-scrollbar{ display:none }  /* cleaner mobile look */
      nav a{ margin:0 4px; padding:8px 10px }

      /* stack layouts */
      .grid{ grid-template-columns:1fr }
      .grid-topic{
        grid-template-columns:1fr;
        grid-template-areas:
          "about"
          "middle"
          "matrix";
      }

      .card{ padding:14px; border-radius:14px }
      .table th,.table td{ padding:8px 6px }
    }

    /* Small tablet gutters */
    @media (min-width:721px) and (max-width:900px){
      main{ padding-inline:16px; }
    }
  </style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div class="brand">Tesla STEM MUN</div>
    <nav id="nav"></nav>
  </div>
</header>

<div id="banner-root"></div>
<main id="app" role="main"></main>

<script>

/* ----- Nav ----- */
function setNav(){
  const nav = document.getElementById('nav');
  const hash = location.hash || '#/';
  const links = [
    {href:'#/',label:'Home'},
    {href:'#/topics',label:'Topics'},
    {href:'#/board',label:'Board'}
  ];
  nav.innerHTML = links.map(a =>
    `<a href="${a.href}" ${hash===a.href ? "aria-current='page'" : ""}>${a.label}</a>`
  ).join('');
}
setNav();
window.addEventListener('hashchange', ()=>{ setNav(); route(); });

/* ----- Helpers ----- */
function esc(s){ return (s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
function usDateToISO(mmddyyyy){
  if(!mmddyyyy) return '';
  if(/\d{4}-\d{2}-\d{2}/.test(mmddyyyy)) return mmddyyyy;
  const m = mmddyyyy.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(!m) return mmddyyyy;
  return `${m[3]}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`;
}
function buildDateTime(dateStr, timeStr){
  const t = (timeStr && timeStr.trim()) ? timeStr.trim() : '12:30';
  return new Date(`${usDateToISO(dateStr)}T${t}`);
}
function showError(e){
  document.getElementById('app').innerHTML =
    `<div class="error"><strong>Data load failed</strong>\n${esc(e.message)}\n\nCheck that /data files exist, are valid, and you are serving over http:// (not file://). Then hard refresh (Ctrl/Cmd+Shift+R).</div>`;
  console.error(e);
}
function renderBanner(site){
  const root = document.getElementById('banner-root');
  const until = site.cancel_until ? usDateToISO(site.cancel_until) : null;
  const msg = site.cancel_all_upcoming ? 'All upcoming meetings are cancelled until further notice.'
            : (until ? `All meetings are cancelled through ${esc(site.cancel_until)}.` : '');
  root.innerHTML = (site.cancel_all_upcoming || until) ? `<div class="banner">${msg}</div>` : '';
}
function isCancelled(site, m){
  const dISO = usDateToISO(m.date);
  if(m.cancelled) return true;
  if(site.cancel_all_upcoming) return true;
  if(site.cancel_until && dISO <= usDateToISO(site.cancel_until)) return true;
  if(Array.isArray(site.cancel_dates) && site.cancel_dates.map(usDateToISO).includes(dISO)) return true;
  return false;
}
/* Render About with paragraphs/newlines. Accepts string or array. */
function renderAboutHTML(about) {
  if (Array.isArray(about)) return about.map(p => `<p>${esc(p)}</p>`).join('');
  if (typeof about !== 'string' || !about.trim()) return '<p class="muted">Add "about" in topics.json</p>';
  return about
    .split(/\n{2,}/)                          // blank line => new paragraph
    .map(p => `<p>${esc(p).replace(/\n/g, '<br>')}</p>`) // single \n => <br>
    .join('');
}

/* ----- CSV Parser (quotes & CRLF) ----- */
function parseCSV(text){
  const out = [];
  let row = [], field = '';
  let i = 0, q = false;

  while (i < text.length) {
    const c = text[i];
    const n = text[i + 1];

    if (q) {
      if (c === '"') {
        if (n === '"') { field += '"'; i += 2; continue; }
        q = false; i++; continue;
      }
      field += c; i++; continue;
    }

    if (c === '"') { q = true; i++; continue; }
    if (c === ',') { row.push(field); field=''; i++; continue; }

    if (c === '\n' || c === '\r') {
      if (field !== '' || row.length) { row.push(field); out.push(row); }
      row = []; field = '';
      if (c === '\r' && n === '\n') i += 2; else i += 1;
      continue;
    }

    field += c; i++;
  }

  if (field !== '' || row.length) { row.push(field); out.push(row); }

  if (!out.length) return [];
  const headers = out[0].map(h => h.trim());
  return out.slice(1).filter(r => r.length).map(r => {
    const obj = {};
    headers.forEach((h, idx) => { obj[h] = (r[idx] || '').trim(); });
    return obj;
  });
}

/* ----- Loaders (STRICT) ----- */
async function loadJSON(path){
  const r = await fetch(path, {cache:'no-store'});
  if(!r.ok) throw new Error(`${path} → HTTP ${r.status}`);
  try { return await r.json(); } catch { throw new Error(`${path} → invalid JSON`); }
}
async function loadCSV(path){
  const r = await fetch(path, {cache:'no-store'});
  if(!r.ok) throw new Error(`${path} → HTTP ${r.status}`);
  const txt = await r.text();
  return parseCSV(txt);
}
async function loadMeetings(){
  // Try CSV first; fallback to JSON; else error
  try {
    const rows = await loadCSV('data/meetings.csv');
    return rows.map(x => ({
      date: x.date || x.day || '',
      time: (x.time || '').trim(),
      duration: (x.duration || '').trim(),
      type: x.type || x.kind || '',
      room: x.room || x.place || x.location || '',
      cancelled: (x.cancelled || '').toString().toLowerCase() === 'true'
    }));
  } catch (csvErr) {
    try {
      const js = await loadJSON('data/meetings.json');
      return (js || []).map(m => ({
        date: m.date || m.day || '',
        time: (m.time || '').trim(),
        duration: (m.duration || '').trim(),
        type: m.type || m.kind || '',
        room: m.room || m.place || m.location || '',
        cancelled: !!m.cancelled
      }));
    } catch (jsonErr) {
      throw new Error(`meetings.csv & meetings.json both failed:\n - ${csvErr.message}\n - ${jsonErr.message}`);
    }
  }
}

/* ----- Pages ----- */
async function renderHome(){
  try{
    const [site, meetings, topics] = await Promise.all([
      loadJSON('data/site.json'),
      loadMeetings(),
      loadJSON('data/topics.json')
    ]);
    renderBanner(site);

    const upcoming = meetings
      .filter(m => !isCancelled(site, m) && buildDateTime(m.date, m.time) >= new Date())
      .sort((a,b) => buildDateTime(a.date,a.time) - buildDateTime(b.date,b.time))[0];

    const next = upcoming ? `
      <div class="hero">
        <h2>Next Meeting <span class="pill ok">${esc(upcoming.type)}</span></h2>
        <div class="muted">${buildDateTime(upcoming.date,upcoming.time).toLocaleString([], {weekday:'long', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit'})}
          ${upcoming.duration ? ` · Duration: <strong>${esc(upcoming.duration)}</strong>` : ''}
        </div>
        <div class="muted">Room: <strong>${esc(upcoming.room)}</strong></div>
      </div>` :
      `<div class="hero"><h2>No upcoming meeting found</h2><div class="muted">Add one in <code>data/meetings.csv</code> or <code>data/meetings.json</code>.</div></div>`;

    const current = topics[0];

    document.getElementById('app').innerHTML = `${next}
      <div class="grid">
        <article class="card">
          <h3>Current Topic</h3>
          ${current ? `
            <div><strong>${esc(current.title)}</strong></div>
            <div class="muted">Resources:</div>
            <div>
              ${(current.links || []).map(e => `<a class="pill ok" href="${e.url}" target="_blank" rel="noopener">${esc(e.label)}</a>`).join(' ') || '<span class="pill">No resources</span>'}
              <a href="#/topic/${encodeURIComponent(current.slug)}">Full topic page →</a>
            </div>` : '<p class="muted">No topics yet.</p>'}
        </article>
        <article class="card">
          <h3>Resources</h3>
          <div>${(site.resources || []).map(r => `<div><a href="${r.url}" target="_blank" rel="noopener">${esc(r.label)}</a></div>`).join('')}</div>
        </article>
      </div>`;
  }catch(e){ showError(e); }
}

async function renderTopics(){
  try{
    const topics = await loadJSON('data/topics.json');
    document.getElementById('app').innerHTML = `<div class="wrap"><h2>Topics</h2>
      <div class="grid">${
        topics.map(t => `<article class="card">
          <h3>${esc(t.title)}</h3>
          <p class="muted">ID: <code>${esc(t.slug)}</code></p>
          <p>${(t.links || []).map(e => `<span class="pill ok"><a href="${e.url}" target="_blank" rel="noopener">${esc(e.label)}</a></span>`).join('') || '<span class="pill">No resources</span>'}</p>
          <p><a href="#/topic/${encodeURIComponent(t.slug)}">Open topic page →</a></p>
        </article>`).join('')}
      </div></div>`;
  }catch(e){ showError(e); }
}

async function renderTopicDetail(slug){
  try{
    const topics = await loadJSON('data/topics.json');
    const t = topics.find(x => x.slug === slug);
    if(!t){ document.getElementById('app').innerHTML = '<div class="wrap">Topic not found.</div>'; return; }

    // Optional embedded Country Matrix CSV
    let matrixHTML = '';
    const path = t.matrix_csv || `data/matrices/${slug}.csv`;
    try{
      const rows = await loadCSV(path);
      if(rows.length){
        const headers = Object.keys(rows[0]);
        matrixHTML = `<div class="card"><h3>Country Matrix</h3>
          <div style="overflow:auto">
            <table class="table">
              <thead><tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}</tr></thead>
              <tbody>${rows.map(r => `<tr>${headers.map(h => `<td>${esc(r[h] || '')}</td>`).join('')}</tr>`).join('')}</tbody>
            </table>
          </div>
        </div>`;
      }
    }catch{ /* matrix is optional */ }

    // Research Links (new)
    const researchSrc = t.research_links || t.research || [];
    const researchItems = Array.isArray(researchSrc) ? researchSrc : [];
    const researchHTML = researchItems.length
      ? `<article class="card">
           <h3>Research Links</h3>
           <ul>${
              researchItems.map(item => {
                if (typeof item === 'string') {
                  const label = item.replace(/^https?:\/\/(www\.)?/,'').replace(/\/$/,'');
                  return `<li><a href="${item}" target="_blank" rel="noopener">${esc(label)}</a></li>`;
                }
                return `<li><a href="${item.url}" target="_blank" rel="noopener">${esc(item.label || item.url)}</a></li>`;
              }).join('')
            }</ul>
         </article>`
      : '';

    // Resources (renamed from Links)
    const resourcesHTML = `<article class="card">
      <h3>Resources</h3>
      <ul>${(t.links || []).map(e => `<li><a href="${e.url}" target="_blank" rel="noopener">${esc(e.label)}</a></li>`).join('') || '<li class="muted">No resources</li>'}</ul>
    </article>`;

    // Layout: left=About, middle=Resources+Research, right=Matrix
    document.getElementById('app').innerHTML = `<div class="wrap">
      <h2>${esc(t.title)}</h2>
      <div class="grid-topic">
        <article class="card col-about">
          <h3>About</h3>
          ${renderAboutHTML(t.about)}
        </article>

        <div class="col-middle">
          ${resourcesHTML}
          ${researchHTML}
        </div>

        ${matrixHTML ? `<div class="col-matrix">${matrixHTML}</div>` : ''}
      </div>
    </div>`;
  }catch(e){ showError(e); }
}

async function renderBoard(){
  try{
    const board = await loadJSON('data/board.json');
    document.getElementById('app').innerHTML = `<div class="wrap">
      <h2>Board</h2>
      <table class="table">
        <thead><tr><th>Member</th><th>Role</th><th>Contact</th></tr></thead>
        <tbody>${
          board.map(b => `<tr>
            <td>${esc(b.name || '')}</td>
            <td>${esc(b.role || '')}</td>
            <td>${b.email ? `<a href="mailto:${b.email}">${esc(b.email)}</a>` : '—'}</td>
          </tr>`).join('')
        }</tbody>
      </table>
    </div>`;
  }catch(e){ showError(e); }
}

/* ----- Router ----- */
function route(){
  const hash = location.hash || '#/';
  const topic = hash.match(/^#\/topic\/([^\s?#]+)/);
  if(topic){ renderTopicDetail(decodeURIComponent(topic[1])); return; }
  if(hash === '#/topics') return renderTopics();
  if(hash === '#/board') return renderBoard();
  return renderHome();
}
route();

function burst(){
  const canvas = document.createElement('canvas');
  canvas.style.cssText = 'position:fixed;inset:0;pointer-events:none;z-index:9999';
  document.body.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  const DPR = devicePixelRatio || 1;
  let w = innerWidth * DPR, h = innerHeight * DPR;
  canvas.width = w; canvas.height = h;

  const colors = ['#7ec8ff','#ff6b6b','#ffd166','#06d6a0','#c77dff','#ff9e00'];
  const parts = Array.from({length:180}, () => ({
    x: Math.random()*w,
    y: -20,
    r: 4+Math.random()*6,
    vx: -2+Math.random()*4,
    vy: 2+Math.random()*3,
    a: 1,
    color: colors[Math.floor(Math.random()*colors.length)]
  }));

  let t = 0, id;
  (function tick(){
    id = requestAnimationFrame(tick);
    t++;
    ctx.clearRect(0,0,w,h);
    parts.forEach(p=>{
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.03;      // slower gravity
      p.a -= 0.004;      // slower fade
      ctx.globalAlpha = Math.max(p.a,0);
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    });
    if(t>600){           // ~10 s instead of 4 s
      cancelAnimationFrame(id);
      canvas.remove();
    }
  })();
}
(function(){
  const seq = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
  let i = 0;

  window.addEventListener('keydown', (e) => {
    const k = (e.key && e.key.length === 1) ? e.key.toLowerCase() : e.key; // normalize 'b'/'a'
    const want = seq[i];
    if (k === want) {
      i++;
      if (i === seq.length) { i = 0; burst(); }
    } else {
      // allow immediate restart if they pressed the first key
      i = (k === seq[0]) ? 1 : 0;
    }
  }, { passive: true });
})();

</script>
</body>
</html>